name: MLflow CI/CD Pipeline - Heart Disease

on:
  push:
    branches: [ main, master ]
    paths:
      - 'MLProject/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  train-and-deploy:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        model: [
          'Logistic_Regression',
          'Random_Forest',
          'Gradient_Boosting',
          'Decision_Tree',
          'K_Nearest_Neighbors',
          'Support_Vector_Machine'
        ]
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python 3.12.7
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install mlflow pandas numpy scikit-learn
    
    - name: Verify MLProject configuration
      run: |
        echo "ðŸ“‹ Checking MLProject file..."
        if [ ! -f "MLProject/MLproject" ]; then
          echo "âŒ MLproject file not found!"
          exit 1
        fi
        echo "âœ… MLproject file found"
        cat MLProject/MLproject
        
        echo ""
        echo "ðŸ“Š Checking dataset..."
        if [ ! -f "MLProject/Heart_Disease_preprocessing.csv" ]; then
          echo "âŒ Dataset not found!"
          exit 1
        fi
        echo "âœ… Dataset found"
    
    - name: Run MLflow Project - ${{ matrix.model }}
      run: |
        cd MLProject
        echo "ðŸš€ Starting MLflow training for: ${{ matrix.model }}"
        mlflow run . \
          --env-manager=local \
          --experiment-name "Heart-Disease-CI" \
          -P model=${{ matrix.model }}
        echo "âœ… Training completed successfully"
      env:
        MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
        MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
        MLFLOW_TRACKING_PASSWORD: ${{ secrets.MLFLOW_TRACKING_PASSWORD }}
    
    - name: Upload MLflow artifacts to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: mlflow-artifacts-${{ matrix.model }}
        path: |
          MLProject/mlruns/
          MLProject/*.csv
          MLProject/*.png
        retention-days: 30

  evaluate:
    name: Evaluate Models
    needs: train-and-deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'
    
    - name: Install dependencies
      run: pip install pandas
    
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
    
    - name: Compare results
      run: |
        python -c "
        import pandas as pd
        import glob
        
        csv_files = glob.glob('artifacts/**/model_comparison_results.csv', recursive=True)
        
        if csv_files:
            dfs = [pd.read_csv(f) for f in csv_files]
            combined = pd.concat(dfs, ignore_index=True).sort_values('test_accuracy', ascending=False)
            
            print('='*70)
            print('ðŸ“Š MODEL COMPARISON RESULTS')
            print('='*70)
            print(combined.to_string(index=False))
            print('='*70)
            
            combined.to_csv('final_results.csv', index=False)
            
            best = combined.iloc[0]
            print(f\"\\nðŸ† BEST MODEL: {best['model']}\")
            print(f\"   Accuracy: {best['test_accuracy']:.4f}\")
            print(f\"   F1-Score: {best['test_f1_score']:.4f}\")
        else:
            print('âŒ No results found!')
            exit(1)
        "
    
    - name: Upload final results
      uses: actions/upload-artifact@v4
      with:
        name: final-results
        path: final_results.csv
        retention-days: 90

  docker-deploy:
    name: Docker Build and Push
    needs: evaluate
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'
    
    - name: Install dependencies
      run: pip install pandas
    
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
    
    - name: Find best model
      id: best-model
      run: |
        python -c "
        import pandas as pd
        import glob
        import os
        
        csv_files = glob.glob('artifacts/**/model_comparison_results.csv', recursive=True)
        
        if csv_files:
            dfs = [pd.read_csv(f) for f in csv_files]
            combined = pd.concat(dfs, ignore_index=True).sort_values('test_accuracy', ascending=False)
            best_model = combined.iloc[0]['model']
            model_tag = best_model.lower().replace('_', '-')
            
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write(f'model_name={best_model}\n')
                f.write(f'model_tag={model_tag}\n')
        "
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}
    
    - name: Build and Push Docker image
      env:
        MODEL_TAG: ${{ steps.best-model.outputs.model_tag }}
      run: |
        cd MLProject
        echo "Building Docker image for Heart Disease model..."
        cat > Dockerfile << 'EOF'
        FROM python:3.12-slim
        WORKDIR /app
        COPY . /app
        RUN pip install --no-cache-dir mlflow pandas numpy scikit-learn
        EXPOSE 5000
        CMD ["python", "modelling.py"]
        EOF
        docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/heart-disease-mlflow:${MODEL_TAG} .
        docker tag ${{ secrets.DOCKERHUB_USERNAME }}/heart-disease-mlflow:${MODEL_TAG} ${{ secrets.DOCKERHUB_USERNAME }}/heart-disease-mlflow:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/heart-disease-mlflow:${MODEL_TAG}
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/heart-disease-mlflow:latest

  summary:
    name: Pipeline Summary
    needs: [train-and-deploy, evaluate, docker-deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Success notification
      if: needs.train-and-deploy.result == 'success' && needs.evaluate.result == 'success'
      run: |
        echo "âœ… MLflow Project training completed"
        echo "âœ… All models trained successfully"
        echo "âœ… Artifacts uploaded to GitHub Actions"
        
        if [ "${{ needs.docker-deploy.result }}" == "success" ]; then
          echo "âœ… Docker image built and pushed to Docker Hub"
        fi
    
    - name: Failure notification
      if: needs.train-and-deploy.result == 'failure' || needs.evaluate.result == 'failure'
      run: |
        echo "âŒ Pipeline failed!"
        exit 1
